<!DOCTYPE html>
<html lang="en" x-data="downloaderApp()" :class="{ 'dark': darkMode }">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>üé¨ 1Downloader</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    body { transition: background 0.5s, color 0.5s; }
  </style>
</head>

<body class="bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col items-center justify-center p-6">

  <div class="text-center">
    <h1 class="text-4xl font-bold mb-4 animate__animated animate__fadeInDown">üé¨ 1Downloader</h1>

    <!-- Dark Mode Toggle -->
    <button @click="toggleDarkMode()" class="mb-5 px-4 py-2 bg-indigo-600 text-white rounded shadow hover:bg-indigo-700 transition">
      Toggle Dark Mode
    </button>

    <!-- URL Input & Format Selector -->
    <div class="flex flex-col md:flex-row items-center gap-3 mb-4 animate__animated animate__fadeIn">
      <input x-model="videoUrl" type="url" placeholder="Paste YouTube video link..." class="border rounded px-4 py-2 w-72">
      <select x-model="selectedFormat" class="border rounded px-4 py-2">
        <option value="mp4">MP4</option>
        <option value="mp3">MP3</option>
        <option value="webm">WebM</option>
      </select>
      <button @click="fetchThumbnail()" class="px-4 py-2 bg-green-500 text-white rounded shadow hover:bg-green-600 transition">
        Get Preview
      </button>
    </div>

    <!-- Thumbnail Preview -->
    <div x-show="thumbnail" class="mb-4 animate__animated animate__fadeIn">
      <img :src="thumbnail" class="mx-auto rounded shadow-lg w-72">
    </div>

    <!-- Download Button -->
    <button @click="startDownload()" :disabled="!thumbnail || downloading" class="px-6 py-2 bg-blue-500 text-white rounded shadow hover:bg-blue-600 transition disabled:opacity-50">
      <span x-show="!downloading">‚¨áÔ∏è Download</span>
      <span x-show="downloading" class="animate-spin">‚è≥ Downloading...</span>
    </button>

    <!-- Progress Bar -->
    <div class="w-72 bg-gray-300 dark:bg-gray-600 rounded-full h-4 mt-4 mx-auto overflow-hidden">
      <div class="bg-green-500 h-4 transition-all duration-300" :style="`width: ${progress}%`"></div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div x-show="toastMessage" class="fixed bottom-5 right-5 bg-green-500 text-white px-4 py-2 rounded shadow animate__animated animate__fadeIn" x-text="toastMessage" x-transition></div>

<script>
  function downloaderApp() {
    return {
      darkMode: false,
      videoUrl: '',
      selectedFormat: 'mp4',
      thumbnail: '',
      downloading: false,
      progress: 0,
      toastMessage: '',
      socket: null,

      toggleDarkMode() {
        this.darkMode = !this.darkMode;
      },

      showToast(message) {
        this.toastMessage = message;
        setTimeout(() => this.toastMessage = '', 3000);
      },

      fetchThumbnail() {
        if (!this.videoUrl.trim()) {
          this.showToast('‚ùó Enter a valid URL');
          return;
        }

        fetch('/get-thumbnail', {
          method: 'POST',
          body: new URLSearchParams({ url: this.videoUrl })
        })
        .then(res => res.json())
        .then(data => {
          this.thumbnail = data.thumbnail;
          this.showToast('‚úÖ Thumbnail Loaded!');
        })
        .catch(() => this.showToast('‚ùó Failed to fetch thumbnail'));
      },

      startDownload() {
        if (!this.thumbnail) {
          this.showToast('‚ùó Please fetch thumbnail first');
          return;
        }

        this.downloading = true;
        this.progress = 0;

        if (!this.socket) {
          this.socket = io();
          this.socket.on('progress_update', data => {
            this.progress = data.progress;
            if (data.progress >= 100) {
              this.downloading = false;
              this.showToast('‚úÖ Download Complete!');
            }
          });
        }

        this.socket.emit('start_download', {
          url: this.videoUrl,
          format: this.selectedFormat
        });
      }
    }
  }
</script>

</body>
</html>
